<html>
    <head>
    </head>
    <body style="margin: 0em 0em">
        <canvas id="canvas" style="float:left;">
        </canvas>
        <textarea id="basic" style="width: 30vw; height: 70vh;">
10 fwd
11 fwd
15 rem
20 goto 10
</textarea>
        <textarea id="log" style="width: 30vw; height: 30vh;"></textarea>
        <script>
document.getElementById('basic').addEventListener('change', e => {
    window.localStorage.setItem('code', e.target.value);
})

var allcode = window.localStorage.getItem("code");
if (allcode) {
    document.getElementById('basic').value = allcode;
}

var canvas = document.getElementById('canvas');
canvas.width = document.body.clientWidth * 0.7;
canvas.height = document.body.clientHeight;
var context = canvas.getContext('2d');
var centerX = canvas.width / 2;
var centerY = canvas.height / 2;
var radius = 200;

function circle(cx, cy, r, start, stop) {
    context.beginPath();
    context.arc(cx, cy, r, start||0, stop||2 * Math.PI, false);
    context.fill();
    context.stroke();
}


context.fillStyle = 'green';
context.lineWidth = 5;
context.strokeStyle = '#003300';
circle(centerX, centerY, radius);

context.fillStyle = 'rgba(0,0,0,0)';

function drawRobot(r, height) {
    circle(centerX, centerY, radius+(height||3), r - 0.01, r + 0.01);
}

var chute1 = 0;//Math.round(Math.random() * 36)*10;
var chute2 = 180;//Math.round(Math.random() * 36)*10;

function sameSpot(p1, p2) {
    var diff = Math.abs(p1 - p2) % 360;
    return diff < 0.1 || diff > 359.9;
}

function isChute(r) {
    return sameSpot(r, chute1) || sameSpot(r, chute2);
}

function log(str) {
    document.getElementById('log').value = str+"\n" + document.getElementById('log').value;
}

var program = document.getElementById('basic').value.toLowerCase().split(/\n/g);
var labels = {};
for (var x in program) {
    var regex = /^([0-9]+)? *(fwd|turn|goto|stop|if chute goto|rem|sleep)? *([0-9]+)? *$/gi
    var match = regex.exec(program[x]);
    if (!match) {
        log("Syntax Error: "+program[x]);
    }
    else if (match[1]) labels[match[1]] = x;
    program[x] = match;
}
var ctr = 0;

var sameDir = 0;//Math.random() < 0.5;
var maxspeed = 0.25;
var r1 = {speed:0, dir:sameDir, ip:0, pos:chute1, height:50, color:"#008"};
var r2 = {speed:0, dir:0, ip:0, pos:chute2, height:50, color:"#800"};

function runRobot(timestamp, r) {
    context.strokeStyle = "#fff";
    drawRobot(r.pos * Math.PI/180, r.height);

    if (r.height > 4) {
        r.height = r.height - 1;
        ctr = -1;
    }
    else {

        if (ctr == 0) {
            while(1) {
                var code = program[r.ip++];
                log(code[0]);
                switch (code[2]) {
                    case "fwd":
                        r.speed = r.dir ? maxspeed : -maxspeed;
                        break;
                    case "turn":
                        r.dir = !r.dir;
                        break;
                    case null:
                    case "":
                    case "rem":
                        continue;
                    case "if chute goto":
                        if (!isChute(r.pos)) continue;
                    case "goto":
                        var oldip = r.ip-1;
                        r.ip = labels[code[3]];
                        if (r.ip != oldip) continue;
                    default:
                        log("Invalid command: "+code[0]);
                    case "sleep":
                    case "stop":
                        r.speed = 0;
                        break;
                }
                break;
            }
        }

        r.pos += r.speed;
    }

    context.strokeStyle = r.color;
    drawRobot(r.pos * Math.PI/180, r.height);
}

function drawFrame(timestamp) {

    runRobot(timestamp, r1);
    runRobot(timestamp, r2);
    if (++ctr == 40) ctr = 0;

    if (!sameSpot(r1.pos, r2.pos)) {
        window.requestAnimationFrame(drawFrame);
    }
    else {
        log("Found you!");
    }
}

window.requestAnimationFrame(drawFrame);

        </script>

    </body>
</html>
